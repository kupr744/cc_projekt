name: ab-testing

on:
  push:
    branches:
      - "ab-testing"

env:
  GCLOUD_AUTHENTICATION_JSON: ${{ secrets.GCLOUD_AUTHENTICATION_JSON }}

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: checkout
      uses: actions/checkout@v3

    - name: authenticate
      uses: 'google-github-actions/auth@v0'
      with:
        credentials_json: '$GCLOUD_AUTHENTICATION_JSON'
    
    - name: rollout
      run: |-
        kubectl apply -f canary_ingress.yaml
        cd web_application/prime-api
        kubectl apply -f canary_service.yaml
        kubectl apply -f canary_deployment.yaml
    